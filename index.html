<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestione Turni Collaboratori</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f0f4f8;
    }
    h1 {
      text-align: center;
    }
    .form-section {
      margin-top: 20px;
    }
    input, select, button {
      margin: 5px 0;
      padding: 8px;
      width: 100%;
      max-width: 300px;
    }
    button {
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background-color: #0056b3;
    }
  </style>
</head>
<body>

<h1>Gestione Turni</h1>

<div id="turniList">
  <h3>Turni inseriti:</h3>
  <ul id="turni"></ul>
</div>

<div id="formSection" class="form-section" style="display:none;">
  <h2>Modifica Turno</h2>
  <label>Data: <input type="date" id="data"></label><br>
  <label>Ora IN: <input type="time" id="oraIn"></label><br>
  <label>Ora OUT: <input type="time" id="oraOut"></label><br>
  <label>Mansione:
    <select id="mansione">
      <option>Assistente bagnanti FERIALE</option>
      <option>Assistente bagnanti FESTIVO</option>
      <option>Cassa FERIALE</option>
      <option>Cassa FESTIVO</option>
      <option>Rotazione FERIALE</option>
      <option>Rotazione FESTIVO</option>
      <option>Istruttore FERIALE</option>
      <option>Istruttore FESTIVO</option>
      <option>Aiuto allenatore FERIALE</option>
      <option>Aiuto allenatore FESTIVO</option>
    </select>
  </label><br>
  <button onclick="salvaDati()">Salva Turno</button>
  <button onclick="generaPDF()">Genera PDF</button>
</div>

<script>
// Variabili e configurazione
let currentUser = "andrea";  // Esempio di utente
let turni = [];  // Elenco dei turni
let selectedTurno = null;  // Turno selezionato per la modifica
const apiUrl = "https://script.google.com/macros/s/AKfycbwi69qWgniUNUg2q4RKLiTW0QqJWQvWMewnV2Mkbaa40jniO-CtRL2ZefWTdqZsGxea_g/exec";  // URL della funzione Google Apps Script

// Funzione per caricare i turni esistenti
function caricaTurni() {
  // Esempio: Dati fittizi dei turni (questi verrebbero recuperati dal server, qui simuliamo un'operazione di recupero)
  turni = [
    { data: "2025-04-01", oraIn: "08:00", oraOut: "12:00", mansione: "Assistente bagnanti FERIALE", utente: "andrea" },
    { data: "2025-04-02", oraIn: "13:00", oraOut: "17:00", mansione: "Cassa FESTIVO", utente: "andrea" },
  ];

  const listaTurni = document.getElementById('turni');
  listaTurni.innerHTML = '';  // Pulisce la lista dei turni

  // Aggiungi i turni alla lista
  turni.forEach((turno, index) => {
    const turnoItem = document.createElement('li');
    turnoItem.textContent = `${turno.data} - ${turno.mansione}`;
    const modificaBtn = document.createElement('button');
    modificaBtn.textContent = 'Modifica';
    modificaBtn.onclick = () => modificaTurno(index);
    turnoItem.appendChild(modificaBtn);
    listaTurni.appendChild(turnoItem);
  });
}

// Funzione per modificare un turno
function modificaTurno(index) {
  selectedTurno = turni[index];  // Seleziona il turno da modificare

  // Rendi visibile il modulo e precompila i campi con i dati del turno selezionato
  document.getElementById('formSection').style.display = 'block';
  document.getElementById('data').value = selectedTurno.data;
  document.getElementById('oraIn').value = selectedTurno.oraIn;
  document.getElementById('oraOut').value = selectedTurno.oraOut;
  document.getElementById('mansione').value = selectedTurno.mansione;
}

// Funzione per salvare i dati del turno
function salvaDati() {
  const data = document.getElementById('data').value;
  const oraIn = document.getElementById('oraIn').value;
  const oraOut = document.getElementById('oraOut').value;
  const mansione = document.getElementById('mansione').value;

  if (!data || !oraIn || !oraOut || !mansione) {
    alert('Compila tutti i campi!');
    return;
  }

  // Modifica il turno esistente
  selectedTurno.data = data;
  selectedTurno.oraIn = oraIn;
  selectedTurno.oraOut = oraOut;
  selectedTurno.mansione = mansione;

  // Simula l'invio dei dati a Google Sheets tramite API
  fetch(apiUrl, {
    method: "POST",
    body: JSON.stringify(selectedTurno),
    headers: { "Content-Type": "application/json" }
  })
  .then(response => response.text())
  .then(res => {
    alert('Turno salvato!');
    caricaTurni();  // Ricarica la lista dei turni
  })
  .catch(error => {
    console.error("Errore salvataggio", error);
    alert('Errore durante il salvataggio!');
  });
}

// Funzione per generare il PDF
function generaPDF() {
  const doc = new jsPDF();

  const data = [
    ["Data", "Ora IN", "Ora OUT", "Mansione", "Collaboratore"],
    [document.getElementById('data').value, document.getElementById('oraIn').value, document.getElementById('oraOut').value, document.getElementById('mansione').value, currentUser]
  ];

  doc.autoTable({
    head: data.slice(0, 1),
    body: data.slice(1),
  });

  doc.save(`Turno_${currentUser}.pdf`);
}

// Carica i turni all'inizio
caricaTurni();

</script>

</body>
</html>
